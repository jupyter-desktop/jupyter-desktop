---
alwaysApply: true
---

# 🧩 **Rules: モノレポ Debugging ガイドライン**

## 🎯 Rule: モノレポのデバッグ手順（AI が必ず守る）

Backendとフロントエンドの連携で問題が発生した際、以下の **3段階デバッグプロセス** に従って原因を特定し、修正提案を行うこと。

---

## **1. Backend テストの実行と修正を最優先とする**

### 手順

* Backend のテストを実行して結果を確認する。
* **期待結果：すべてのテストが成功していること。**

### 失敗があった場合

* 失敗したテストのエラーメッセージを確認する。
* **問題切り分けの原則**: 問題が起きたら小さい単位でテストして問題を切り分けて対処する。
  * 全体テストではなく、個別のテストケースや関数単位で実行する。
  * エラーメッセージから原因を特定し、該当箇所のみを修正する。
  * 修正後、該当テストを再実行して確認する。
* エラー内容に基づきコードを修正する。
* **重要**: ソースコードを変更したら上書き保存する。
* 再度テストを実行し、成功するまで繰り返す。

### AI の指針

* フロントエンドの問題よりも、Backend 側のテスト失敗を優先して原因を分析する。
* Backend テストが赤の状態で、フロント側の解析を先に行うような提案をしない。
* 問題が発生した場合、まず最小単位のテストで原因を特定してから修正する。

---

## **2. フロントエンドの統合テストを実行・確認する**

### 前提

* **backend サーバーが起動していること。**
* **重要**: サーバー側を変更したら、サーバーを再起動する。
  * バックエンドのコード変更後は、必ずサーバーを停止して再起動する。
  * サーバー再起動後、ヘルスチェックエンドポイント（`/healthz`）で起動確認を行う。

### 手順

* フロントエンドの統合テストを実行し、結果を確認する。
* **期待結果：すべてのテストが成功していること。**

### 失敗があった場合

* 失敗したテストのエラーメッセージを確認する。
* **問題切り分けの原則**: 問題が起きたら小さい単位でテストして問題を切り分けて対処する。
  * 統合テスト全体ではなく、個別のテスト関数やAPIエンドポイント単位で確認する。
  * タイムアウトやエラーメッセージから原因を特定し、該当箇所のみを修正する。
  * 必要に応じて、デバッグログを追加して詳細を確認する。
* 必要に応じてコードを修正する。
* **重要**: ソースコードを変更したら上書き保存する。
* **重要**: サーバー側を変更した場合は、サーバーを再起動する。
* テストを再実行し、成功するまで繰り返す。

### AI の指針

* Backend が起動していない状態では、フロント統合テストの正しい結果が出ないことを前提に推論する。
* エラーメッセージが Backend 側の未起動・通信失敗に起因していないか常に確認する。
* タイムアウトエラーが発生した場合、まずサーバーが起動しているか、サーバーが最新のコードで実行されているかを確認する。

---

## **3. E2E テストで最終確認を行う**

### 前提

* **backend サーバーが起動していること。**
* **重要**: サーバー側を変更したら、サーバーを再起動する。

### 手順

* E2E テストを実行し、最終的なアプリ全体の動作を確認する。
* **期待結果：すべての E2E テストが成功すること。**

### 失敗があった場合

* E2E の詳細ログを確認して原因を特定する。
* **問題切り分けの原則**: 問題が起きたら小さい単位でテストして問題を切り分けて対処する。
  * E2Eテスト全体ではなく、個別のシナリオやステップ単位で確認する。
  * ブラウザの DevTools コンソールのエラーを確認する。
  * ネットワークタブでAPI通信の成功/失敗を確認する。
  * バックエンドログでエラーや警告を確認する。
* 必要に応じて Backend または Frontend のコードを修正する。
* **重要**: ソースコードを変更したら上書き保存する。
* **重要**: サーバー側を変更した場合は、サーバーを再起動する。
* テストを再実行し、成功するまで繰り返す。

### AI の指針

* E2E の failures は Frontend と Backend の「どちらの問題か」を逐次切り分ける。
* E2E のテスト内容だけで判断せず、ログ・コンソール・API 通信結果を加味して推論する。
* 問題が複雑な場合は、最小単位のテストで原因を特定してから修正する。

---

# 🔧 **AI の生成物に適用されるメタルール**

## デバッグプロセスの優先順位

1. 上記 3 ステップのデバッグプロセスを **常に優先**して提案や原因推定を行うこと。
2. 原因分析・修正提案は、必ずこの順序に従って段階的に進めること。
3. ユーザーが「問題はどこ？」と質問した場合も、同じく 3 ステップで切り分ける。
4. E2E の結果だけで原因を断定しない。必ず Backend → Frontend → E2E の順で確認する。
5. 「効率化のために順序を飛ばす」ことは絶対にしない。

## 問題切り分けの原則

6. **問題が起きたら小さい単位でテストして問題を切り分けて対処する。**
   * 全体テストではなく、個別のテストケースや関数単位で実行する。
   * エラーメッセージから原因を特定し、該当箇所のみを修正する。
   * デバッグログを追加して詳細を確認する。
   * 修正後、該当テストを再実行して確認する。

## コード変更とサーバー管理

7. **ソースコードを変更したら上書き保存する。**
   * ファイルを編集した後、必ず保存する。
   * 保存されていない変更がある場合、テスト結果が不正確になる可能性がある。

8. **サーバー側を変更したら、サーバーを再起動する。**
   * バックエンドのコード変更後は、必ずサーバーを停止して再起動する。
   * サーバー再起動後、ヘルスチェックエンドポイント（`/healthz`）で起動確認を行う。
   * サーバーが最新のコードで実行されていることを確認してからテストを実行する。

## エラーハンドリング

9. タイムアウトエラーが発生した場合、以下の順序で確認する：
   * サーバーが起動しているか
   * サーバーが最新のコードで実行されているか（再起動が必要か）
   * ネットワーク接続が正常か
   * ログにエラーや警告がないか

10. デッドロックやロック競合のエラーが発生した場合：
    * ロックの取得順序を確認する
    * ロックを取得した状態で他のロックを取得しようとしていないか確認する
    * 必要に応じて、ロック取得済みの状態で呼び出せる内部メソッドを作成する
